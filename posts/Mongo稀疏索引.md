---

date: 2025-07-24
tags: [Mongo]
---

在MongoDB中，稀疏索引（Sparse Index）是一种特殊类型的索引，它仅对集合中包含被索引字段的文档建立索引条目，而忽略那些不包含该字段的文档。这种设计使得稀疏索引在特定场景下能显著节省存储空间并提升索引效率。

## 核心特性

1. 选择性索引
   稀疏索引只包含那些实际拥有被索引字段的文档。如果文档中不存在该字段，则不会为其创建索引条目。这与普通索引（对所有文档创建条目，缺失字段会被视为null并索引）形成对比。

2. 节省存储空间
   由于跳过了不含目标字段的文档，稀疏索引通常比普通索引占用更少的存储空间，尤其适用于字段分布稀疏的场景（例如，只有少数文档包含某个字段）。

3. 查询行为差异
   • 覆盖查询：如果查询条件仅涉及稀疏索引字段且能被索引完全覆盖（无需回表），MongoDB可以直接使用稀疏索引返回结果，效率较高。

   • 非覆盖查询：若查询需要检查缺失该字段的文档（例如查找字段值为null或字段不存在的文档），稀疏索引无法满足需求，MongoDB需扫描全集合。（这种情况Mongo也会进行优化，当需要非覆盖查询时，Mongo会忽略稀疏索引。除非用户显式的指定使用稀疏索引）

## 适用场景

1. 字段可选且分布稀疏
   当某个字段仅被部分文档使用（如用户的“手机号”字段，可能只有部分用户填写），稀疏索引可以避免为大量无此字段的文档创建冗余条目。

2. 唯一性约束但不要求全集合唯一
   结合unique: true选项，稀疏索引可确保仅对包含该字段的文档强制唯一性。例如，多个文档可能没有“邮箱”字段，但拥有该字段的文档必须保证邮箱地址唯一。（这就类似于MySql会将null看作唯一值）

3. 避免全集合扫描
   若查询条件明确针对稀疏字段（如{ "premiumUser": true }），且该字段仅存在于少数文档中，稀疏索引能快速定位目标文档，避免全表扫描。

创建稀疏索引

在MongoDB中，通过createIndex()方法并指定sparse: true选项创建稀疏索引。例如：
// 为"email"字段创建稀疏且唯一的索引
db.users.createIndex({ email: 1 }, { sparse: true, unique: true });


## 注意事项

1. 查询设计需匹配索引
   若查询条件可能涉及缺失该字段的文档（如查找email为null或字段不存在的文档），稀疏索引无法加速此类查询，需结合其他索引或全集合扫描。

2. 复合索引中的稀疏性
   在复合索引中，若某个字段被标记为稀疏，整个索引会继承稀疏性。此时，索引条目仅包含那些包含所有稀疏字段的文档（需谨慎设计）。

3. 性能权衡
   虽然稀疏索引节省空间，但若查询频繁涉及缺失字段的文档，可能导致更多全集合扫描，需根据业务场景权衡。

## 查写性能

根据测试，在查询相同的document的复合查询下，稀疏索引会略慢于普通索引，而在插入时则会快于普通索引。单条数据下差异可忽略不计，nest形式对写入性能会有一定的影响。

## 需要注意的

对于稀疏索引，如果某个字段为null，该字段依然会被稀疏索引所捕获，可以参考官方文档对其的解释：[document](https://www.mongodb.com/zh-cn/docs/manual/core/index-sparse/#:~:text=Sparse%20indexes%20only%20contain%20entries%20for%20documents%20that,any%20document%20that%20is%20missing%20the%20indexed%20field.)

> 稀疏索引仅包含具有索引字段的文档的条目，即使索引字段是null值。